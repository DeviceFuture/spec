# 0002: ThunderNet API
| Property | Value |
|----------|-------|
| Status | Awaiting review |
| Product(s) (if any) or area | ThunderNet |
| Author(s) | james@devicefuture.org |
| Reviewer(s) (if any) | (N/A) |
| Submission date | 2021-03-18 |
| Acceptance date | [YYYY-MM-DD[G1]] |
| Addresses issue(s) (if any) | (N/A) |
| Review discussion | [Link to review discussion[G4]] |

## Synopsis
To ensure a standardised communication between ThunderNet nodes[F1] and their endpoints[F1], this document defines a specification of the various API routes will be set out to ensure maximum compatibility between various projects using the ThunderNet network.

## Details
To ensure privacy though encryption, endpoints must communicate with a node using an **endpoint profile** unique to both the node and the endpoint. An **endpoint profile** is an object which contains a referential **endpoint profile ID** and AES encryption/decryption key for secure and unique communications between a node and an endpoint. It is a JSON object containing an **endpoint profile ID** (key `id`), a JSON Web Key (JWK; key `jwk`) and an array of a node's WAN IP address(es) and/or domain name(s) which are commonly known as host addresses (key `hosts`). This is an array since multiple nodes could share the same endpoint profile collection.

The **endpoint profile ID** uniquely identifies an endpoint, and a single endpoint can have multiple endpoint profile IDs. Each ID is randomly generated by the node and is usually composed of 16 alphanumeric characters.

For the purposes of secure and convenient encryption and decryption[F2], we will be using AES in Counter Mode[F3].

### Routes
Below is a list of node API routes which will be callable from endpoints to communicate with the ThunderNet network.

#### GET `/version`
Gets the current version number and API level of the target ThunderNet node. The response should be a JSON object containing the version string (without a `v` prefix; key `version`) and numeric API level value (key `apiLevel`), which starts at 0 and is incremented for every API change.

**Route parameters:** (None)

**Response type:** JSON

**Restrictions:** (Unrestricted)

**Example response:** GET `/version`
```json
{
    "version": "1.2.3",
    "apiLevel": 12
}
```

#### GET `/register`
Creates a new endpoint profile for usage with encryption on the node, and returns an endpoint profile object containing an AES encryption/decryption key in JWK format (key `jwk`) in addition to the generated endpoint profile ID for further communications (key `id`). Both the node and the endpoint should safely store the endpoint profile ID since it will not be transmitted again.

> **Recommendation:** This route should only be called when the endpoint is on a trusted internet network. Otherwise, the AES encryption/decryption key could be captured by a malicious actor through a MITM attack. Under normal circumstances, the AES encryption/decryption key should only be held by the node and the endpoint to ensure a private connection.

**Route parameters:** (None)

**Response type:** JSON of endpoint profile

**Restrictions:** (Unrestricted)

**Example response:** GET `/register`
```json
{
    "id": "ZC4HNjxdHxoHoabV",
    "jwk": {
        "alg": "A256GCM",
        "ext": true,
        "k": "FwrPbj7_K27dCxU7qxf1ct-C-29N2din11mQpWSrbQk",
        "key_ops": ["encrypt", "decrypt"],
        "kty": "oct"
    },
    "hosts": ["example.com"]
}
```

### URL query parameters
Below are the query parameters which can be supplied when calling certain routes.

#### `epid`
The endpoint profile ID to use when encrypting a decryptable response.

**Type:** String

## Footnotes
[F1] See #0001 for definition.

[F2] It is convenient to perform decryption on the endpoint using this method since it is widely implemented through SubtleCrypto: https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/decrypt

[F3] https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/encrypt#aes-ctr
