# 0002: ThunderNet API
| Property | Value |
|----------|-------|
| Status | Accepted |
| Product(s) (if any) or area | ThunderNet |
| Author(s) | james@devicefuture.org |
| Reviewer(s) (if any) | (N/A) |
| Submission date | 2021-03-18 |
| Acceptance date | 2021-03-19 |
| Addresses issue(s) (if any) | (N/A) |
| Review discussion | [GH#2](https://github.com/DeviceFuture/spec/pull/2) |

## Synopsis
To ensure standardised communications between ThunderNet nodes[F1] and their endpoints[F1], this document defines a specification of the various API routes that will be set out to ensure maximum compatibility between various projects using the ThunderNet network.

## Details
To ensure privacy though encryption, endpoints must communicate with a node using an **endpoint profile** unique to both the node and the endpoint. An **endpoint profile** is an object which contains a referential **endpoint profile ID** and AES encryption/decryption key for secure and unique communications between a node and an endpoint. It is a JSON object containing an **endpoint profile ID** (key `id`), a JSON Web Key (JWK; key `jwk`) and an array of a node's WAN IP address(es) and/or domain name(s) which are commonly known as host addresses (key `hosts`). This is an array since multiple nodes could share the same endpoint profile collection.

The **endpoint profile ID** uniquely identifies an endpoint, and a single endpoint can have multiple endpoint profile IDs. Each ID is randomly generated by the node and is usually composed of 16 alphanumeric characters.

For the purposes of secure and convenient encryption and decryption[F2], we will be using AES in Counter Mode[F3] with a 256-bit key.

### Routes
Below is a list of node API routes which will be callable from endpoints to communicate with the ThunderNet network.

#### GET `/`
Has no specific behaviour. It is recommended that the node redirects the visitor to `https://devicefuture.org` to raise awareness about DeviceFuture and ThunderNet.

**Response type:** (Any)

**Restrictions:** (Unrestricted)

**Example response:** GET `/`: 301
```
https://devicefuture.org
```

#### GET `/about`
Gets various up-to-date information about the target ThunderNet node. The response should be a JSON object containing the version string (without a `v` prefix; key `version`) and numeric API level value (key `apiLevel`), which starts at 0 and is incremented for every API change.

So that endpoints can determine whether the node is in operation, the JSON response should include a status (key `status`), which can be any of these values:
* **`"active"`:** Node is available for general use.
* **`"tempoff"`:** Node is temporarily not in use and may need maintenance (to be carried out by the node's operator) due to a reached limit. The `until` key containing a UNIX epoch millisecond timestamp will be provided as a date for when the node should be active again.
* **`"error"`:** Node is experiencing high error rates (possibly due to issues with connecting to the internet). This may be cleared automatically.
* **`"off"`:** Node is not in use at this time. This may be cleared at the discretion of the node's operator.
* **`"decommissioned"`:** Node is no longer in use. Endpoints should not communicate with this node again.

The JSON response may include an optional informative string (key `info`) which contains human-readable information about a node.

**Response type:** JSON

**Restrictions:** (Unrestricted)

**Example response:** GET `/about`: 200
```json
{
    "version": "1.2.3",
    "apiLevel": 12,
    "status": "active",
    "info": "Read more about this node to learn how I operate it: https://example.com"
}
```

#### GET `/register`
Creates a new endpoint profile for usage with encryption on the node, and returns an endpoint profile object containing an AES encryption/decryption key in JWK format (key `jwk`) in addition to the generated endpoint profile ID for further communications (key `id`). Both the node and the endpoint should safely store the endpoint profile ID since it will not be transmitted again.

> **Recommendation:** This route should only be called when the endpoint is on a trusted internet network. Otherwise, the AES encryption/decryption key could be captured by a malicious actor through a MITM attack. Under normal circumstances, the AES encryption/decryption key should only be held by the node and the endpoint to ensure a private connection.

**Response type:** JSON of endpoint profile

**Restrictions:** (Unrestricted)

**Example response:** GET `/register`: 200
```json
{
    "id": "ZC4HNjxdHxoHoabV",
    "jwk": {
        "alg": "A256GCM",
        "ext": true,
        "k": "FwrPbj7_K27dCxU7qxf1ct-C-29N2din11mQpWSrbQk",
        "key_ops": ["encrypt", "decrypt"],
        "kty": "oct"
    },
    "hosts": ["example.com"]
}
```

#### GET `/access`
Retrieves a ThunderNet resource based on an internet resource located at a given URL (URL query parameter `url`). The internet resource may be modified (such as through compression or content stripping) before it is sent. The resource may also have been cached by the node, unless the `cache` URL query parameter is explicitly set to `false`.

The response given is compressed (though the LZMA encryption/decryption algorithm[F4]) and then encrypted using the chosen endpoint profile configuration. The endpoint should decrypt and then decompress the response in that order to interpret the resource.

The retrieved resource may then be reused for caching and indexing purposes.

Any erroneous HTTP status codes sent from the originating resource server should be returned to the endpoint as a 502 status, and `/access` should return the contents as normal. The endpoint can choose how it should render the contents depending on the final resource's MIME type. If the originating resource server cannot be found, then a 504 status should be returned instead.

**Response type:** Raw encoded (binary) data with MIME type dependent on retrieved resource.

**Restrictions:**
* The `epid` parameter must be present and matching an endpoint profile ID.
* The `url` parameter must be present and accessible.

**Example response:** GET `/access?epid=ZC4HNjxdHxoHoabV&url=http%3A%2F%2Fexample.com%2F`: 200 (decoded)
```html
<main><h1>Example Domain</h1><p>This domain is for use in illustrative examples in documents. You may use this domain in literature without prior coordination or asking for permission.</p><p><a href="https://www.iana.org/domains/example">More information...</a></p></main>
```

#### GET `/version`
Retrieves the version information about a ThunderNet resource based on an internet resource located at a given URL (URL query parameter `url`). The response should be a JSON object containing a hex-encoded SHA-256 hash of the resource (key `hash`), a UNIX epoch millisecond timestamp of when the resource was first retrieved (key `firstRetrieved`) and another timestamp of when the resource was last updated (key `lastUpdated`).

The rationale behind this route is so that endpoints can test an internally-cached resource to see whether it reflects the current state of the resource (which may also be retrieved from the node's frequently-updated cache) so that resources can remain fresh and have an unlikelihood of becoming stale.

**Response type:** JSON

**Restrictions:**
* The `url` parameter must be present and accessible.

**Example response:** GET `/version?url=http%3A%2F%2Fexample.com%2F`: 200
```json
{
    "hash": "e8963dbe6fe9aa4a576f2af3fd69d976b8491b938050f0dbd703d4e5d7739d0e",
    "firstRetrieved": 1609998684000,
    "lastUpdated": 1616179264000
}
```

### URL query parameters
Below are the query parameters which can be supplied when calling certain routes.

#### `epid`
The endpoint profile ID to use when encrypting a decryptable response.

**Type:** String

#### `url`
A URL of a resource from the internet to retrieve the contents of.

> **Recommendation:** The URL should be encoded so that it can be safely decoded as a URI component. This can be achieved through using `encodeURIComponent`[F5] in JavaScript.

**Type:** String (in URL format)

#### `cache`
Whether to retrieve resources from a node's cache if it exists.

**Type:** Boolean (either `true` or `false`)

### Error handling
If unexpected behaviour is encountered, ThunderNet nodes should return errors if the request cannot be completed. The errors should be returned in a JSON format, and with a suitable HTTP status code, as shown below.

| Situation                                          | HTTP status code | JSON response                         |
|----------------------------------------------------|------------------|---------------------------------------|
| Node is unavailable for general use                | 503              | `{"error": "statusNotActive"}`        |
| Route does not exist                               | 404              | `{"error": "nonexistentRoute"}`       |
| Originating resource server communications failure | 504              | `{"error": "communicationsFailure"}`  |
| Request quota exceeded for endpoint                | 429              | `{"error": "quotaExceeded"}`          |
| Resource is too large to send                      | 413              | `{"error": "resourceTooLarge"}`       |
| Unsatisfied restriction                            | 400              | `{"error": "unsatisfiedRestriction"}` |

## Footnotes
[F1] See #0001 for definition.

[F2] It is convenient to perform decryption on the endpoint using this method since it is widely implemented through SubtleCrypto: https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/decrypt

[F3] https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/encrypt#aes-ctr

[F4] https://github.com/LZMA-JS/LZMA-JS

[F5] https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent
